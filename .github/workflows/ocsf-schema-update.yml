name: "OCSF: Update Schema References"

on:
  schedule:
    - cron: "0 6 * * *" # Daily at 6 AM UTC
  workflow_dispatch: # Manual trigger

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      update: ${{ steps.check.outputs.update }}
      current: ${{ steps.current.outputs.version }}
      latest: ${{ steps.latest.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Get current version
        id: current
        run: |
          # Find version directories (exclude 'docs' and other non-version dirs)
          CURRENT=$(find plugins/ocsf/skills/understanding-ocsf/references/ \
            -maxdepth 1 -type d -name '[0-9]*' \
            | xargs -r -n1 basename \
            | sort -V \
            | tail -1)
          echo "version=${CURRENT:-none}" >> $GITHUB_OUTPUT
          echo "Current version: ${CURRENT:-none}"

      - name: Get latest OCSF version
        id: latest
        run: |
          LATEST=$(curl -sf https://schema.ocsf.io/api/version | jq -r '.version')
          if [ -z "$LATEST" ] || [ "$LATEST" = "null" ]; then
            echo "Failed to fetch latest OCSF version"
            exit 1
          fi
          echo "version=$LATEST" >> $GITHUB_OUTPUT
          echo "Latest version: $LATEST"

      - name: Check if update needed
        id: check
        run: |
          if [ "${{ steps.current.outputs.version }}" != "${{ steps.latest.outputs.version }}" ]; then
            echo "update=true" >> $GITHUB_OUTPUT
            echo "Update needed: ${{ steps.current.outputs.version }} -> ${{ steps.latest.outputs.version }}"
          else
            echo "update=false" >> $GITHUB_OUTPUT
            echo "Already up to date: ${{ steps.current.outputs.version }}"
          fi

  update:
    needs: check
    if: needs.check.outputs.update == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Generate app token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.TENZIR_GITHUB_APP_ID }}
          private-key: ${{ secrets.TENZIR_GITHUB_APP_PRIVATE_KEY }}

      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Generate new references
        run: |
          cd plugins/ocsf
          uv run scripts/generate-references.py

      - name: Force-add references (gitignored)
        run: |
          git add -f plugins/ocsf/skills/understanding-ocsf/references/

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ steps.app-token.outputs.token }}
          commit-message: "Update OCSF references to ${{ needs.check.outputs.latest }}"
          title: "Update OCSF references to ${{ needs.check.outputs.latest }}"
          body: |
            üîÑ Automated update of OCSF schema references.

            - ‚¨ÖÔ∏è Previous: ${{ needs.check.outputs.current }}
            - ‚û°Ô∏è New: ${{ needs.check.outputs.latest }}
          branch: ocsf-update-${{ needs.check.outputs.latest }}
