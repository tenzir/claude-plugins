name: "OCSF: Sync Documentation"

on:
  schedule:
    - cron: "0 7 * * *" # Daily at 7 AM UTC
  workflow_dispatch: # Manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Generate app token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.TENZIR_GITHUB_APP_ID }}
          private-key: ${{ secrets.TENZIR_GITHUB_APP_PRIVATE_KEY }}

      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Sync OCSF docs
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          cd plugins/ocsf
          uv run scripts/sync-docs.py

      - name: Check for changes
        id: changes
        run: |
          git add -f plugins/ocsf/skills/understanding-ocsf/references/docs/
          git add plugins/ocsf/skills/understanding-ocsf/SKILL.md
          if git diff --cached --quiet; then
            echo "update=false" >> $GITHUB_OUTPUT
            echo "No changes to commit"
          else
            echo "update=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.update == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ steps.app-token.outputs.token }}
          commit-message: "Sync OCSF documentation"
          title: "Sync OCSF documentation"
          body: |
            ðŸ”„ Automated sync of OCSF articles and FAQs from [ocsf/ocsf-docs](https://github.com/ocsf/ocsf-docs).
          branch: ocsf-docs-sync
